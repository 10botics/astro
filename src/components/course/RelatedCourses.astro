---
import { Image } from 'astro:assets';

interface Props {
  // For news-to-courses context
  newsTags?: string[];
  newsTitle?: string;
  
  // For course-to-courses context  
  courseTags?: string[];
  courseTitle?: string;
  currentCourseSlug?: string;
  
  // Common props
  maxResults?: number;
  context?: 'news' | 'course'; // Determines styling and behavior
}

const { 
  newsTags = [], 
  newsTitle = '', 
  courseTags = [], 
  courseTitle = '', 
  currentCourseSlug = '', 
  maxResults, 
  context = 'news' 
} = Astro.props;

// Determine the actual tags and settings based on context
const tags = context === 'news' ? newsTags : courseTags;
const title = context === 'news' ? newsTitle : courseTitle;
const defaultMaxResults = context === 'news' ? 9 : 6;
const finalMaxResults = maxResults ?? defaultMaxResults;

// Auto-discover .astro course files (same approach as index.astro)
const courseFiles = await import.meta.glob('../../pages/school-courses/*.astro', { eager: true });

// Convert .astro files to course data (excluding index and dynamic routes)
const astroCourses = Object.entries(courseFiles)
  .filter(([path]) => !path.includes('./index.astro') && !path.includes('./[slug].astro'))
  .map(([path, module]: [string, any]) => {
    const filename = path.replace('../../pages/school-courses/', '').replace('.astro', '');
    
    // Map Chinese filenames to English URLs (same mapping as index.astro)
    const slugMapping: Record<string, string> = {
      'äººå·¥æ™ºèƒ½éŠæˆ²ç·¨ç¨‹èª²ç¨‹': 'ai-game-coding',
      'AIå•Ÿè’™èˆ‡è—è¡“å‰µä½œèª²ç¨‹': 'ai-enrichment-course',
      'AIæ•¸ç¢¼å‹•ç•«å±•': 'ai-digital-animation-exhibition',
      'Blockchain å€å¡Šéˆèª²ç¨‹': 'blockchain',
      'CoDroneç„¡äººæ©Ÿèª²ç¨‹': 'codrone',
      'Delightex éŠæˆ²è¨­è¨ˆèª²ç¨‹': 'delightex-game-design',
      'Donkey Car ç„¡äººè»Šèª²ç¨‹': 'donkey-car',
      'Dobot æ™ºèƒ½æ©Ÿæ¢°æ‰‹è‡‚': 'dobot',
      'kspå¤ªç©ºè¨ˆåŠƒèª²ç¨‹': 'ksp',
      'Lego Spike Prime æ©Ÿå™¨äººæŠ€è¡“å¤§å¸«ç­': 'lego-spike-prime',
      'Minecraftæ ¡åœ’å‰µå»ºèª²ç¨‹': 'minecraft',
      'Microbit é™è½å‚˜èª²ç¨‹': 'microbit-parachute',
      'Microbit é€ƒå‡ºè¿·å®®': 'microbit-maze',
      'Procreateæ•¸ä½è—è¡“èª²ç¨‹': 'procreate',
      'raspberry-piç·¨ç¨‹èª²ç¨‹': 'raspberry-pi',
      'Scratch äººå·¥æ™ºèƒ½ç·¨ç¨‹': 'scratch-ai-programming',
      'ScratchéŠæˆ²è¨­è¨ˆèª²ç¨‹': 'scratch-game-design',
      'SwiftPlaygroundsç·¨ç¨‹èª²ç¨‹': 'swiftplaygrounds',
      'Tello ç„¡äººæ©Ÿèª²ç¨‹': 'tello',
      'çŠç‘šç’°å¢ƒç›£æ¸¬å…¥é–€èª²ç¨‹': 'coral-environment-monitoring',
      'Unity èª²ç¨‹': 'unity',
      'è‡ªç„¶ç”Ÿç‰©æ¢ç©¶æ‰‹ä½œèª²ç¨‹': 'natural-bio-sciences',
      'Python åˆéšéŠæˆ²ç·¨ç¨‹': 'python-game-dev-beginner'
    };
    
    // Extract courseData from frontmatter (now accessible via import.meta.glob)
    const courseData = module.courseData || {
      title: filename,
      description: `${filename} èª²ç¨‹é é¢`,
      tags: [filename.replace('-', ' ')]
    };
    
    return {
      slug: slugMapping[filename] || filename,
      filename: `${filename}.astro`,
      title: courseData.title,
      subtitle: courseData.subtitle || '',
      description: courseData.description,
      tags: courseData.tags || [],
      heroImage: courseData.heroImage,
      source: 'astro'
    };
  });

const schoolCourses = astroCourses;

// Function to calculate tag similarity score
function calculateTagSimilarity(courseTags: string[], inputTags: string[]): number {
  if (!courseTags || !inputTags) return 0;
  
  const courseTagsLower = courseTags.map(tag => tag.toLowerCase().trim());
  const inputTagsLower = inputTags.map(tag => tag.toLowerCase().trim());
  
  // Count matching tags (exact and partial matches)
  let score = 0;
  
  for (const inputTag of inputTagsLower) {
    for (const courseTag of courseTagsLower) {
      if (inputTag === courseTag) {
        score += 5; // Exact match gets highest score
      } else if (inputTag.includes(courseTag) || courseTag.includes(inputTag)) {
        score += 2; // Partial match gets medium score
      } else {
        // Check for key Chinese phrases and concepts
        const keywordMatches = checkKeywordMatches(inputTag, courseTag);
        if (keywordMatches > 0) {
          score += keywordMatches;
        }
      }
    }
  }
  
  return score;
}

// Helper function to check for keyword matches
function checkKeywordMatches(inputTag: string, courseTag: string): number {
  let matches = 0;
  
  // AI related terms
  if ((inputTag.includes('ai') || inputTag.includes('äººå·¥æ™ºèƒ½') || inputTag.includes('aiæ•™è‚²') || inputTag.includes('aiè—è¡“')) 
      && (courseTag.includes('ai') || courseTag.includes('äººå·¥æ™ºèƒ½'))) {
    matches += 3;
  }
  
  // Programming related terms
  if ((inputTag.includes('ç¼–ç¨‹') || inputTag.includes('ç¨‹å¼') || inputTag.includes('coding') || inputTag.includes('programming'))
      && (courseTag.includes('programming') || courseTag.includes('ç¼–ç¨‹') || courseTag.includes('ç¨‹å¼') || courseTag.includes('coding'))) {
    matches += 2;
  }
  
  // Art related terms
  if ((inputTag.includes('è—è¡“') || inputTag.includes('è‰ºæœ¯') || inputTag.includes('å‰µä½œ') || inputTag.includes('åˆ›ä½œ'))
      && (courseTag.includes('arts') || courseTag.includes('è—è¡“') || courseTag.includes('è‰ºæœ¯') || courseTag.includes('å‰µä½œ') || courseTag.includes('åˆ›ä½œ'))) {
    matches += 2;
  }
  
  // Drone related terms
  if ((inputTag.includes('ç„¡äººæ©Ÿ') || inputTag.includes('æ— äººæœº') || inputTag.includes('drone'))
      && (courseTag.includes('ç„¡äººæ©Ÿ') || courseTag.includes('æ— äººæœº') || courseTag.includes('drone') || courseTag.includes('tello'))) {
    matches += 3;
  }
  
  // Robotics related terms
  if ((inputTag.includes('æ©Ÿå™¨äºº') || inputTag.includes('æœºå™¨äºº') || inputTag.includes('robot'))
      && (courseTag.includes('æ©Ÿå™¨äºº') || courseTag.includes('æœºå™¨äºº') || courseTag.includes('robot'))) {
    matches += 2;
  }
  
  // Game development related terms
  if ((inputTag.includes('éŠæˆ²') || inputTag.includes('æ¸¸æˆ') || inputTag.includes('game'))
      && (courseTag.includes('éŠæˆ²') || courseTag.includes('æ¸¸æˆ') || courseTag.includes('game'))) {
    matches += 2;
  }
  
  // STEM related terms
  if ((inputTag.includes('stem') || inputTag.includes('ç§‘å­¸') || inputTag.includes('ç§‘å­¦') || inputTag.includes('å·¥ç¨‹'))
      && (courseTag.includes('stem') || courseTag.includes('ç§‘å­¸') || courseTag.includes('ç§‘å­¦') || courseTag.includes('å·¥ç¨‹'))) {
    matches += 1;
  }
  
  // Education level matches
  if ((inputTag.includes('ä¸­å­¸') || inputTag.includes('ä¸­å­¦') || inputTag.includes('åˆä¸­') || inputTag.includes('é«˜ä¸­'))
      && (courseTag.includes('ä¸­å­¸') || courseTag.includes('ä¸­å­¦') || courseTag.includes('åˆä¸­') || courseTag.includes('é«˜ä¸­'))) {
    matches += 1;
  }
  
  if ((inputTag.includes('å°å­¸') || inputTag.includes('å°å­¦') || inputTag.includes('é«˜å°'))
      && (courseTag.includes('å°å­¸') || courseTag.includes('å°å­¦') || courseTag.includes('é«˜å°'))) {
    matches += 1;
  }
  
  return matches;
}

// Filter and sort school courses
const relatedCourses = schoolCourses
  .filter(course => {
    // For course context, exclude the current course
    if (context === 'course' && currentCourseSlug && course.slug === currentCourseSlug) {
      return false;
    }
    return true;
  })
  .map(course => {
    const similarity = calculateTagSimilarity(course.tags || [], tags);
    return {
      ...course,
      similarity
    };
  })
  .filter(course => course.similarity > 0) // Only include courses with tag matches
  .sort((a, b) => {
    // Sort by similarity score (descending)
    return b.similarity - a.similarity;
  })
  .slice(0, finalMaxResults);

// Determine styling and content based on context
const colorScheme = context === 'news' 
  ? { bg: 'from-blue-50 to-cyan-50', button: 'bg-blue-600 hover:bg-blue-700', tag: 'bg-blue-100 text-blue-800 hover:bg-blue-200', gradient: 'from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700', hover: 'hover:text-blue-600' }
  : { bg: 'from-green-50 to-emerald-50', button: 'bg-green-600 hover:bg-green-700', tag: 'bg-green-100 text-green-800 hover:bg-green-200', gradient: 'from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700', hover: 'hover:text-green-600' };

const audienceColorScheme = context === 'news'
  ? { tag: 'bg-cyan-100 text-cyan-800 hover:bg-cyan-200' }
  : { tag: 'bg-emerald-100 text-emerald-800 hover:bg-emerald-200' };

const sectionTitle = context === 'news' ? 'ç›¸é—œèª²ç¨‹æ¨è–¦' : 'ç›¸é—œèª²ç¨‹æ¨è–¦';
const sectionDescription = context === 'news' 
  ? `åŸºæ–¼${title ? `ã€Œ${title}ã€` : 'æ­¤æ–°è'}çš„å…§å®¹ï¼Œç‚ºæ‚¨æ¨è–¦ç›¸é—œçš„å­¸æ ¡èª²ç¨‹`
  : `åŸºæ–¼${title ? `ã€Œ${title}ã€` : 'æ­¤èª²ç¨‹'}çš„å…§å®¹ï¼Œç‚ºæ‚¨æ¨è–¦å…¶ä»–ç›¸é—œèª²ç¨‹`;

const shouldLimitTags = context === 'course';
---

{relatedCourses.length > 0 && (
  <section class={`py-16 bg-gradient-to-br ${colorScheme.bg}`}>
    <div class="container mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-bold text-gray-900 mb-4">{sectionTitle}</h2>
        <p class="text-lg text-gray-600">
          {sectionDescription}
        </p>
      </div>

      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {relatedCourses.map((course) => (
          <article class="course-card bg-white rounded-lg shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden">
            {/* Hero Image */}
            {course.heroImage && (
              <div class="course-image-container bg-gray-100 overflow-hidden aspect-video">
                {typeof course.heroImage === 'string' ? (
                  <Image 
                    src={course.heroImage} 
                    alt={course.title}
                    width={600}
                    height={400}
                    class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                  />
                ) : (
                  <Image 
                    src={course.heroImage} 
                    alt={course.title}
                    width={600}
                    height={400}
                    class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                  />
                )}
              </div>
            )}
            {!course.heroImage && (
              <div class={`h-48 bg-gradient-to-r ${context === 'news' ? 'from-blue-400 via-cyan-400 to-blue-500' : 'from-green-400 via-emerald-400 to-green-500'} relative overflow-hidden`}>
                <div class={`absolute inset-0 bg-gradient-to-r ${context === 'news' ? 'from-blue-600/20 to-cyan-600/20' : 'from-green-600/20 to-emerald-600/20'}`}></div>
                <div class="absolute inset-0 flex items-center justify-center">
                  <div class="text-white text-center p-4">
                    <div class="text-3xl mb-2">ğŸ“š</div>
                    <div class="text-sm font-medium opacity-90">èª²ç¨‹å°é¢</div>
                  </div>
                </div>
              </div>
            )}
            
            <div class="p-6">
              {/* Course Header */}
              <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                  <h3 class="text-xl font-bold text-gray-800 line-clamp-2">
                    <a href={`/school-courses/${course.slug}`} 
                       class={`${colorScheme.hover} transition-colors`}>
                      {course.title}
                    </a>
                  </h3>
                  <div class="flex items-center text-yellow-500 ml-2">
                  </div>
                </div>
                
                {course.description && (
                  <p class="text-gray-600 text-sm line-clamp-3 mb-4">
                    {course.description}
                  </p>
                )}
              </div>
              
              {/* Tags */}
              <div class="mb-4">
                {(() => {
                  const targetAudienceTags = ['åˆå°', 'é«˜å°', 'åˆä¸­', 'é«˜ä¸­'];
                  const otherTags = course.tags.filter((tag: string) => !targetAudienceTags.includes(tag));
                  const audienceTags = course.tags.filter((tag: string) => targetAudienceTags.includes(tag));
                  
                  return (
                    <div class="space-y-2">
                      {/* Target Audience */}
                      {audienceTags.length > 0 && (
                        <div class="flex flex-wrap gap-1 items-center">
                          <span class="text-xs font-medium text-gray-600 mr-1">é©åˆå°è±¡:</span>
                          {audienceTags.map((tag: string) => {
                            // Tag mapping for target audience tags
                            const audienceTagMapping = {
                              'åˆå°': 'lower-primary',
                              'é«˜å°': 'upper-primary', 
                              'åˆä¸­': 'junior-secondary',
                              'é«˜ä¸­': 'senior-secondary'
                            };
                            
                            const tagSlug = audienceTagMapping[tag] || tag.toLowerCase().replace(/\s+/g, '-');
                            
                            return (
                              <a href={`/school-courses/tag/${tagSlug}`} class={`${audienceColorScheme.tag} px-2 py-1 rounded text-xs font-medium transition-colors`}>
                                {tag}
                              </a>
                            );
                          })}
                        </div>
                      )}
                      
                      {/* Other Tags */}
                      {otherTags.length > 0 && (
                        <div class="flex flex-wrap gap-1">
                          {(shouldLimitTags ? otherTags.slice(0, 3) : otherTags).map((tag: string) => {
                            // Tag mapping for Chinese to English URLs (same as index.astro)
                            const chineseToEnglishMapping = {
                      // Chinese tags to English equivalents
                      'åˆä¸­': 'junior-secondary',
                      'é«˜ä¸­': 'senior-secondary', 
                      'é«˜å°': 'upper-primary',
                      'åˆå°': 'lower-primary',
                      'å°å­¸': 'primary',
                      'éŠæˆ²é–‹ç™¼': 'game-development',
                      'ç¶²é éŠæˆ²': 'web-games',
                      'ç„¡äººæ©Ÿ': 'drone',
                      'è»Ÿä»¶é–‹ç™¼': 'software-development',
                      'æ•¸ä½è—è¡“': 'digital-art',
                      'å‰µæ„': 'creativity',
                      'ç¹ªç•«': 'drawing',
                      'è™›æ“¬å¯¦å¢ƒ': 'virtual-reality',
                      'VR è™›æ“¬å¯¦å¢ƒ': 'vr-virtual-reality',
                      'AR æ“´å¢å¯¦å¢ƒ': 'ar-augmented-reality',
                      'å‹•ç•«å‰µä½œ': 'animation-creation',
                      'äº’å‹•é«”é©—': 'interactive-experience',
                      'AI äººå·¥æ™ºèƒ½': 'ai',
                      'Programming ç·¨ç¨‹': 'programming',
                      'Block Coding æ–¹å¡Šç·¨ç¨‹': 'block-coding',
                      'Arts è—è¡“': 'arts',
                      'Engineering å·¥ç¨‹': 'engineering',
                      'Science ç§‘å­¸': 'science',
                      'ç§‘å­¸': 'science',
                      'STEM Day': 'stem-day',
                      // Technology and platform specific tags
                      'ChatGPT': 'chatgpt',
                      'Leonardo AI': 'leonardo-ai',
                      'Delightex': 'delightex',
                      'Metaverse å…ƒå®‡å®™': 'metaverse',
                      'å…ƒå®‡å®™': 'metaverse',
                      'Microbit': 'microbit',
                      'Micro:bit': 'microbit',
                      'Blockchain å€å¡Šéˆ': 'blockchain',
                      'Dobot': 'dobot',
                      'KSP': 'ksp',
                      'Lego': 'lego',
                      'Robotics æ©Ÿæ¢°äºº': 'robotics',
                      'Coral': 'coral',
                      'Python': 'python',
                      'Raspberry Pi': 'raspberry-pi',
                      'Tensorflow': 'tensorflow',
                      'Swift Playground': 'swift-playground',
                      '3D å»ºæ¨¡': '3d-modeling',
                      'C#': 'csharp',
                      'Unity': 'unity',
                      'æ•…äº‹é–‹ç™¼': 'story-development',
                      'ç·¨ç¨‹': 'programming',
                      'æ‰‹ä½œ': 'hands-on',
                      'IoT': 'iot',
                      'æµ·æ´‹ç’°å¢ƒ': 'marine-environment',
                      'Arduino': 'arduino',
                      'Tello': 'tello',
                      'Scratch': 'scratch',
                      'Procreate': 'procreate',
                      'Donkey Car': 'donkey-car',
                      'CoDrone': 'codrone',
                      'Minecraft': 'minecraft',
                      // Additional mappings for broader categories
                      'AI': 'ai',
                      'è—è¡“': 'arts',
                      'å…¶ä»–': 'others'
                    };

                            // Check if we have a mapping for this tag
                            const mappedTag = (chineseToEnglishMapping as any)[tag] || tag;
                            
                            // Create a more robust slug that handles Chinese characters
                            const tagSlug = mappedTag
                              .toLowerCase()
                              .replace(/\s+/g, '-')
                              .replace(/[^\w-]/g, '') // Remove all non-word characters except hyphens
                              .replace(/-+$/, '');
                            
                            return (
                              <a href={`/school-courses/tag/${tagSlug}`}
                                 class={`${colorScheme.tag} px-2 py-1 rounded text-xs font-medium transition-colors`}>
                                {tag}
                              </a>
                            );
                          })}
                          {shouldLimitTags && otherTags.length > 3 && (
                            <span class="text-xs text-gray-500 px-2 py-1">
                              +{otherTags.length - 3} æ›´å¤š
                            </span>
                          )}
                        </div>
                      )}
                    </div>
                  );
                })()}
              </div>
              
              {/* Action Button */}
              <div class="mt-auto">
                <a href={`/school-courses/${course.slug}`}
                   class={`inline-block w-full text-center ${colorScheme.button} text-white px-4 py-2 rounded transition-colors text-sm font-medium`}>
                  æŸ¥çœ‹èª²ç¨‹è©³æƒ…
                </a>
              </div>
            </div>
          </article>
        ))}
      </div>

      {/* Show More Link */}
      {relatedCourses.length >= finalMaxResults && (
        <div class="text-center mt-12">
          <a 
            href="/school-courses" 
            class={`inline-flex items-center bg-gradient-to-r ${colorScheme.gradient} text-white px-8 py-3 rounded-lg transition-all duration-300 font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-0.5`}
          >
            ç€è¦½æ‰€æœ‰èª²ç¨‹
            <svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
          </a>
        </div>
      )}
    </div>
  </section>
)}

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
